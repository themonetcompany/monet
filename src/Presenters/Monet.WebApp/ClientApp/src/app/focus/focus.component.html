<div class="p-5">
  @if (viewModel(); as vm) {
    <div class="flex items-start justify-between gap-3">
      <div>
        @if (vm.project) {
          <p class="text-xs text-stone-400">Projet</p>
          <h1 class="mt-1 text-xl font-semibold text-stone-950">{{ vm.project.name }}</h1>
        } @else if (vm.area) {
          <p class="text-xs text-stone-400">Domaine</p>
          <h1 class="mt-1 text-xl font-semibold text-stone-950">{{ vm.area.name }}</h1>
        } @else {
          <p class="text-xs text-stone-400">Sélection</p>
          <h1 class="mt-1 text-xl font-semibold text-stone-950">Choisissez un projet ou un domaine</h1>
          <p class="mt-2 text-sm text-stone-500">Cliquez dans la barre de navigation pour voir le détail.</p>
        }
      </div>
      @if (vm.project || vm.area) {
        <button
          type="button"
          class="rounded-full bg-stone-100 px-3 py-1 text-xs font-semibold uppercase tracking-wider text-stone-600"
          (click)="openConfig()"
        >
          Configuration
        </button>
      }
    </div>

    @if (vm.project || vm.area) {
      <div class="mt-4 flex flex-wrap gap-2">
        <button
          type="button"
          (click)="setTab('income')"
          [class]="activeTab() === 'income'
            ? 'rounded-full bg-stone-950 px-3 py-1 text-xs font-semibold text-white'
            : 'rounded-full bg-stone-100 px-3 py-1 text-xs font-semibold text-stone-500'"
        >
          Revenus
        </button>
        <button
          type="button"
          (click)="setTab('expense')"
          [class]="activeTab() === 'expense'
            ? 'rounded-full bg-stone-950 px-3 py-1 text-xs font-semibold text-white'
            : 'rounded-full bg-stone-100 px-3 py-1 text-xs font-semibold text-stone-500'"
        >
          Dépenses
        </button>
      </div>

      <div class="mt-4 rounded-xl border border-stone-200 bg-white p-4">
        <div class="flex justify-center">
          <div
            class="relative flex h-40 w-40 items-center justify-center rounded-full"
            [style.background]="donutBackground(categories())"
          >
            <div class="flex h-24 w-24 flex-col items-center justify-center rounded-full bg-white">
              <p class="text-[10px] uppercase tracking-wider text-stone-400">
                @if (activeTab() === 'income') { Revenus } @else { Dépenses }
              </p>
              <p class="mt-1 text-sm font-semibold text-stone-950">
                {{ total() | currency: 'EUR':'symbol':'1.0-0' }}
              </p>
            </div>
          </div>
        </div>

        <div class="mt-5 space-y-3">
          @for (item of categories(); track item.id) {
            <div class="flex items-center gap-3">
              <div class="h-3 w-3 rounded-full" [class]="item.colorClass"></div>
              <div class="flex-1">
                <div class="flex items-center justify-between text-xs text-stone-600">
                  <span class="font-medium text-stone-900">{{ item.name }}</span>
                  <span>
                    {{ item.amount | currency: 'EUR':'symbol':'1.0-0' }} ·
                    {{ categoryPercent(item.amount, total()) }}%
                  </span>
                </div>
                <div class="mt-1 h-1.5 rounded-full bg-stone-200">
                  <div
                    class="h-1.5 rounded-full"
                    [class]="item.colorClass"
                    [style.width.%]="categoryPercent(item.amount, total())"
                  ></div>
                </div>
              </div>
            </div>
          }
        </div>

        <div class="mt-6 border-t border-stone-100 pt-4">
          <p class="text-[10px] font-semibold uppercase tracking-wider text-stone-400">
            Transactions revenus + dépenses
          </p>
          <div class="mt-3 space-y-3">
            @for (transaction of transactions(); track transaction.id) {
              <div class="flex items-center justify-between text-xs text-stone-600">
                <div class="min-w-0">
                  <p class="truncate text-sm font-medium text-stone-900">{{ transaction.label }}</p>
                  <p class="mt-0.5 text-[10px] text-stone-500">
                    {{ transaction.dateLabel }} · {{ transaction.categoryName }}
                  </p>
                </div>
                <span class="shrink-0 font-semibold text-stone-900">
                  {{ transaction.amount | currency: 'EUR':'symbol':'1.0-0' }}
                </span>
              </div>
            }
          </div>
        </div>
      </div>
    }
  }

  @if (isConfigOpen()) {
    <div class="fixed inset-0 z-40 flex items-center justify-center bg-stone-950/40 p-4">
      <div class="w-full max-w-md rounded-2xl bg-white p-6 shadow-lg">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-stone-950">Compte par défaut</h2>
          <button
            type="button"
            class="rounded-full bg-stone-100 px-2 py-1 text-xs font-semibold text-stone-600"
            (click)="closeConfig()"
          >
            Fermer
          </button>
        </div>

        <div class="mt-4">
          <label class="block text-xs font-semibold uppercase tracking-wider text-stone-400">
            Compte associé
            <select
              class="mt-2 w-full rounded-xl border border-stone-200 px-3 py-2 text-sm text-stone-900 focus:border-stone-400 focus:outline-none"
              [value]="selectedAccountId()"
              (change)="selectedAccountId.set($any($event.target).value)"
            >
              @for (account of accounts(); track account.id) {
                <option [value]="account.id">{{ account.name }}</option>
              }
            </select>
          </label>
        </div>

        <div class="mt-6 flex items-center justify-end gap-2">
          <button
            type="button"
            class="rounded-full bg-stone-100 px-4 py-2 text-xs font-semibold uppercase tracking-wider text-stone-600"
            (click)="closeConfig()"
          >
            Annuler
          </button>
          <button
            type="button"
            class="rounded-full bg-stone-950 px-4 py-2 text-xs font-semibold uppercase tracking-wider text-white"
            (click)="saveConfig()"
          >
            Valider
          </button>
        </div>
      </div>
    </div>
  }
</div>
