<section class="space-y-8 px-6 py-6">
  <header class="flex flex-wrap items-center justify-between gap-4">
    <div>
      <h1 class="text-2xl font-semibold tracking-tight text-stone-900">Dashboard</h1>
      <p class="text-sm text-stone-500">Vue globale de vos comptes et transactions.</p>
    </div>
    <button
      type="button"
      class="rounded-md border border-stone-300 bg-white px-4 py-2 text-sm font-medium text-stone-700 transition hover:bg-stone-50 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-stone-500"
      (click)="refresh()"
    >
      Rafraîchir
    </button>
  </header>

  @if (loading$ | async) {
    <div class="rounded-lg border border-stone-200 bg-white p-6 text-sm text-stone-500">
      Chargement du dashboard...
    </div>
  } @else {
    @if (error$ | async; as errorMessage) {
      <div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700">
        {{ errorMessage }}
      </div>
    } @else {
      <section class="space-y-4">
        <h2 class="text-lg font-semibold text-stone-900">
          Balance de tous les comptes ({{ accountCount$ | async }})
        </h2>

        <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
          @for (currencyTotal of (totalBalanceByCurrency$ | async) ?? []; track currencyTotal.currency) {
            <article class="rounded-lg border border-stone-200 bg-white p-4">
              <p class="text-xs uppercase tracking-wide text-stone-400">
                Total {{ currencyTotal.currency }}
              </p>
              <p class="mt-2 text-2xl font-semibold text-stone-900">
                {{ currencyTotal.total | currency: currencyTotal.currency : 'symbol' : '1.2-2' }}
              </p>
            </article>
          } @empty {
            <article class="rounded-lg border border-stone-200 bg-white p-4 text-sm text-stone-500">
              Aucun compte disponible.
            </article>
          }
        </div>

        <div class="overflow-x-auto rounded-lg border border-stone-200 bg-white">
          <table class="min-w-full divide-y divide-stone-200 text-sm">
            <thead class="bg-stone-50 text-left text-xs uppercase tracking-wide text-stone-500">
              <tr>
                <th class="px-4 py-3">Compte</th>
                <th class="px-4 py-3">Balance</th>
                <th class="px-4 py-3">Devise</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-stone-100">
              @for (account of (accountBalances$ | async) ?? []; track account.accountNumber) {
                <tr>
                  <td class="px-4 py-3 font-medium text-stone-900">{{ account.accountNumber }}</td>
                  <td class="px-4 py-3">
                    {{ account.balance | currency: account.currency : 'symbol' : '1.2-2' }}
                  </td>
                  <td class="px-4 py-3 text-stone-500">{{ account.currency }}</td>
                </tr>
              } @empty {
                <tr>
                  <td class="px-4 py-4 text-stone-500" colspan="3">Aucun compte disponible.</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </section>

      <section class="space-y-4">
        <h2 class="text-lg font-semibold text-stone-900">
          Liste complète des transactions ({{ transactionCount$ | async }})
        </h2>

        <div class="overflow-x-auto rounded-lg border border-stone-200 bg-white">
          <table class="min-w-full divide-y divide-stone-200 text-sm">
            <thead class="bg-stone-50 text-left text-xs uppercase tracking-wide text-stone-500">
              <tr>
                <th class="px-4 py-3">Date</th>
                <th class="px-4 py-3">Description</th>
                <th class="px-4 py-3">Compte</th>
                <th class="px-4 py-3">Montant</th>
                <th class="px-4 py-3">Catégorie</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-stone-100">
              @for (transaction of (transactions$ | async) ?? []; track transaction.transactionId) {
                <tr>
                  <td class="px-4 py-3 text-stone-700">
                    {{ transaction.date | date: 'dd/MM/yyyy' }}
                  </td>
                  <td class="px-4 py-3 font-medium text-stone-900">{{ transaction.description }}</td>
                  <td class="px-4 py-3 text-stone-600">{{ transaction.accountNumber }}</td>
                  <td class="px-4 py-3">
                    {{ transaction.amount.value | currency: transaction.amount.currency : 'symbol' : '1.2-2' }}
                  </td>
                  <td class="px-4 py-3">
                    @if (transaction.flowType === 'Neutral') {
                      <span class="text-sm text-stone-400">Non catégorisable</span>
                    } @else {
                      @let transactionCategories = categoryOptionsForTransaction(transaction) | async;
                      <select
                        class="w-full rounded-md border border-stone-300 bg-white px-3 py-2 text-sm text-stone-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-stone-500"
                        [(ngModel)]="transaction.categoryId"
                        (change)="updateTransactionCategory(transaction, $event)"
                      >
                        <option value="null">Sans catégorie</option>
                        @for (category of transactionCategories; track category.categoryId) {
                          <option [value]="category.categoryId">
                            {{ category.name }}
                          </option>
                        }
                      </select>
                    }
                  </td>
                </tr>
              } @empty {
                <tr>
                  <td class="px-4 py-4 text-stone-500" colspan="5">
                    Aucune transaction disponible.
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </section>
    }
  }
</section>
